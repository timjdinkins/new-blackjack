<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<title>Play BlackJack</title>
	<link rel="stylesheet" href="/stylesheets/default.css" type="text/css" /
	<script type="text/javascript" src="/javascripts/jquery-1.4.1.min.js"></script>
	<script type="text/javascript" src="/javascripts/underscore-min.js"></script>
</head>

<body>
	
	<h1>Play BlackJack for Fun and Profit.</h1>
	
	<form action="/" method="post" id="registration">
		<label for="name">Your name: </label>
		<input type="text" name="name" value="tim" id="name" />
		<input type="submit" name="submit" value="Register" />
	</form>
	
	<br /><br />
	
	<div id="table" style="height: 100px;">
		<div id="player-cards" style="float: left; width: 400px"></div>
		<div id="dealer-cards" style="float: left; width: 300px; display: none;"></div>
	</div>
	
	<br /><br />
	
	<form action="/" method="post" id="actions">
		<label for="bet">Actions:</label>
		<input type="button" name="bet-5" value="Bet $5" />
		<input type="button" name="bet-10" value="Bet $10" />
		<input type="button" name="bet-20" value="Bet $20" />
		&nbsp;&nbsp;|&nbsp;&nbsp;
		<input type="button" name="hit" value="Hit" />
		&nbsp;|&nbsp;
		<input type="button" name="stay" value="Stay" />
	</form>
	
	<h2>Stack: <span id="stack">200</span></h2>
	
	<div id="messages"></div>
	
	<script type="text/javascript" charset="utf-8">
		var Game = {name: null, resps: []};
		$(function() {
			
			resetCards();
			
			$('#registration').submit(function() {
				register(this.name.value);
				return false;
			});
			
			$('#actions input').each(function() {
				$(this).click(function() {
					var ps = $(this).attr('name').split('-');
					
					if (ps[0] === 'stay') {
						stay();
					}
					else if (ps[0] === 'hit') {
						hit();
					}
					else {
						bet(ps[1]);
					}
				});
			})
		});
		
		function bet(amt) {
			$.post('/action', {name: Game.name, a: 'bet', amt: amt}, function(data) {}, 'json');
		}
		
		function hit() {
			$.post('/action', {name: Game.name, a: 'hit'}, function(data) {}, 'json');
		}
		
		function stay() {
			$.post('/action', {name: Game.name, a: 'stay'}, function(data) {}, 'json');
		}

		function register(name) {
			Game.name = name;
			$.post('/register', {name: name}, function(data) {
					console.log(data.msgs[0].val);
					pollServer(name);
					$.post('/action', {name: name, a: 'join_table'}, function(data) {
						if (data && data.msgs) { handleResp(data) }
					}, 'json');
				}, 'json');
		}

		function pollServer(name) {
			$.post('/listen', {name: name}, function(data) {
				if (data) { handleResp(data) };
				pollServer(name);
			}, 'json');
		}

		function handleResp(data) {
			Game.resps.push(data);
			if (data.msgs.length) {
				_.each(data.msgs, function(m) {
					if (m.type == "msg") {
						if (m.val == "Starting a new game") {
							resetCards();
						}
						else if (m.val != 'ok') {
							appendMsg(m.val);
						}
					}
					else if (m.type === "error") {
						appendMsg("Error: " + m.val);
					}
					else if (m.type === "table_update") {
						if (m.cards) {
							if (m.seat === "dealer") {
								updateCards(m.cards, $('#dealer-cards'));
							}
							else {
								$('#dealer-cards').show();
								updateCards(m.cards, $('#player-cards'));
							}
						}
						else if (m.bet) {
							appendMsg("Seat: " + m.seat + " bet " + m.bet);
						}
					}
					else if (m.type === "bust") {
						appendMsg("Busted with a score of: " + m.score);
					}
					else if (m.type === "result") {
						if (m.result === "won" || m.result === "lost") {
							appendMsg("You " + m.result + " " + m.amt);
						}
						else if (m.result === "tie") {
							appendMsg("It's a tie");
						}
						if (m.stack) {
							$('#stack').html('$' + m.stack);
						}
					}
				});
			}
		}
		
		var Q = [];
		
		function appendMsg(msg) {
			Q.push(msg);
			if (Q.length > 3) {
				Q.shift();
			}
			var ms = $('#messages');
			ms.empty();
			_.each(Q, function(m) {
				$('#messages').append('<p>' + m + '</p>');
			});
		}
		
		function updateCards(cards, table) {
			table.empty();
			
			_.each(cards, function(c) {
				if (_.isNumber(c.val)) {
					if (c.val == 10) {
						v = 't';
					}
					else {
						v = c.val;
					}
				}
				else {
					v = c.val[0].toLowerCase();
				}
				s = c.suit[0].toLowerCase();
				// var card = $('img').val('src', v + s + ".gif");
				var card = $('<img src=\'/images/' + v + s + '.gif\' />');
				$(card).appendTo(table);
			});
		}
		
		function cardBack() {
			return "<img src=\"/images/b.gif\" alt=\"Card Back\" />";
		}
		
		function resetCards() {
			$('#player-cards').empty();
			$('#dealer-cards').empty().append(cardBack()).append(cardBack()).hide();
		}
	</script>

</body>
</html>
